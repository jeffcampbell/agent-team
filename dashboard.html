<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Yamanote Dashboard</title>
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Ccircle cx='16' cy='16' r='14' fill='%239acd32' /%3E%3Ccircle cx='16' cy='16' r='8' fill='%23fff' /%3E%3C/svg%3E">
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: Helvetica, 'Segoe UI', Arial, sans-serif;
    background: #f2f2f2;
    color: #333;
    min-height: 100vh;
  }

  .header {
    display: flex; justify-content: space-between; align-items: center;
    padding: 12px 24px;
    background: #1a1a1a;
    color: #9acd32;
  }
  .header h1 {
    font-size: 1.1rem; font-weight: 700;
    letter-spacing: 3px; text-transform: uppercase;
  }
  .header-right { display: flex; gap: 16px; font-size: 0.8rem; color: #777; }

  .conn-lost {
    display: none; padding: 8px; text-align: center;
    background: #e81123; color: #fff; font-weight: bold; font-size: 0.85rem;
  }
  .conn-lost.visible { display: block; }

  /* ── Loop Pipeline (SVG scales via viewBox) ── */
  .loop-section {
    padding: 24px 20px 16px;
    display: flex; justify-content: center;
  }
  .loop-svg {
    width: 100%;
    max-width: 880px;
    height: auto;
  }
  .loop-svg text {
    font-family: Helvetica, 'Segoe UI', Arial, sans-serif;
  }
  .dot-active {
    transform-box: fill-box;
    transform-origin: center;
    animation: dotPulse 2s ease-in-out infinite;
  }
  @keyframes dotPulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.35); }
  }

  /* ── Agent Cards ── */
  .agents-grid {
    display: flex; flex-wrap: wrap; justify-content: center;
    gap: 10px; padding: 0 24px 12px;
  }
  .agents-grid .agent-card { min-width: 155px; }
  .train-groups-row {
    display: flex; flex-wrap: wrap; justify-content: center;
    gap: 10px; width: 100%; padding-top: 2px;
  }
  .agent-card {
    background: #fff; padding: 10px 12px;
    border: 2px solid #e0e0e0;
    border-radius: 4px;
  }
  .agent-card.running { border-color: #9acd32; }
  .agent-card.cooldown { border-color: #ffb300; }

  /* ── Train group cards ── */
  .train-group { min-width: 155px; }
  .train-group {
    background: #fff; padding: 0;
    border: 2px solid #e0e0e0;
    border-radius: 4px;
  }
  .train-group.has-running { border-color: #9acd32; }
  .train-group.type-express { border-left: 3px solid #ffb300; }
  .train-group.type-regular { border-left: 3px solid #9acd32; }
  .train-group-header {
    display: flex; align-items: center; gap: 8px;
    padding: 10px 12px; cursor: pointer; user-select: none;
  }
  .train-group-header:hover { background: #fafafa; }
  .train-group-arrow {
    font-size: 0.65rem; color: #999; transition: transform 0.15s;
    flex-shrink: 0;
  }
  .train-group.open .train-group-arrow { transform: rotate(90deg); }
  .train-group-summary { flex: 1; display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
  .train-group-detail {
    display: none; border-top: 1px solid #f0f0f0;
    padding: 0;
  }
  .train-group.open .train-group-detail { display: block; }
  .train-detail-row {
    padding: 8px 12px 8px 28px;
    border-bottom: 1px solid #f5f5f5;
    font-size: 0.72rem; color: #666;
  }
  .train-detail-row:last-child { border-bottom: none; }
  .train-detail-id { font-weight: 600; color: #333; }
  .train-detail-spec { color: #999; margin-left: 8px; }
  .agent-name {
    font-weight: 700; font-size: 0.78rem;
    text-transform: uppercase; letter-spacing: 0.5px; color: #333;
  }
  .agent-badge {
    display: inline-block; font-size: 0.55rem; padding: 1px 5px;
    font-weight: 700; margin-left: 4px;
    text-transform: uppercase; border-radius: 2px;
  }
  .badge-running { background: #9acd32; color: #fff; }
  .badge-idle { background: #eee; color: #999; }
  .badge-cooldown { background: #ffb300; color: #fff; }
  .agent-detail { font-size: 0.7rem; color: #999; margin-top: 2px; }

  /* ── Stats ── */
  .stats-bar {
    display: flex; gap: 20px; padding: 4px 24px 12px;
    font-size: 0.78rem; color: #888; flex-wrap: wrap;
  }
  .stat-item strong { color: #333; }
  .stat-sleep { color: #e81123; font-weight: 700; }

  /* ── Station Board ── */
  .station-section {
    padding: 0 24px 16px;
  }
  .station-board {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 10px;
  }
  @media (max-width: 900px) { .station-board { grid-template-columns: 1fr; } }

  .board-panel {
    background: #0c0c0c;
    border: 1px solid #2a2a2a;
    border-radius: 4px;
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }
  .board-header {
    background: linear-gradient(135deg, #1a1200 0%, #2a1e00 50%, #1a1200 100%);
    border-bottom: 1px solid #c8860044;
    padding: 10px 12px 8px;
  }
  .board-header-line1 {
    display: flex; align-items: baseline; gap: 8px;
  }
  .board-title {
    font-size: 0.9rem; font-weight: 800;
    letter-spacing: 4px; color: #c88600;
    text-transform: uppercase;
  }
  .board-count {
    font-size: 0.65rem; font-weight: 700;
    color: #7a5000; letter-spacing: 1px;
  }
  .board-subtitle {
    font-size: 0.55rem; font-weight: 600;
    color: #5a3800; letter-spacing: 3px;
    text-transform: uppercase; margin-top: 2px;
  }
  .board-col-headers {
    display: grid;
    padding: 5px 10px;
    border-bottom: 1px solid #1e1e1e;
    font-size: 0.5rem; font-weight: 700;
    color: #4a4a4a; letter-spacing: 2px;
    text-transform: uppercase;
    background: #0f0f0f;
  }
  .board-col-headers.cols-backlog   { grid-template-columns: 84px 1fr 46px 40px; }
  .board-col-headers.cols-traveling { grid-template-columns: 84px 1fr 44px 48px; }
  .board-col-headers.cols-arrived   { grid-template-columns: 84px 1fr 130px; }

  .board-rows {
    flex: 1;
    overflow-y: auto;
    max-height: 260px;
    min-height: 80px;
  }
  .board-row {
    display: grid;
    padding: 7px 10px;
    border-bottom: 1px solid #141414;
    align-items: center;
    gap: 4px;
  }
  .board-row:last-child { border-bottom: none; }
  .board-row.cols-backlog   { grid-template-columns: 84px 1fr 46px 40px; }
  .board-row.cols-traveling { grid-template-columns: 84px 1fr 44px 48px; }
  .board-row.cols-arrived   { grid-template-columns: 84px 1fr 130px; }
  .board-row:hover { background: #111; }

  .board-empty {
    padding: 18px 12px;
    color: #333;
    font-size: 0.72rem;
    letter-spacing: 1px;
    text-transform: uppercase;
    text-align: center;
  }

  /* Status badges */
  .status-badge {
    display: inline-flex; align-items: center;
    font-size: 0.5rem; font-weight: 800;
    padding: 2px 6px; border-radius: 2px;
    letter-spacing: 1.5px; text-transform: uppercase;
    white-space: nowrap;
  }
  .badge-waiting   { background: #1a1a1a; color: #555; border: 1px solid #2a2a2a; }
  .badge-creating  { background: #0d1f0d; color: #6abf69; border: 1px solid #2a4a2a;
                     animation: badgePulse 2s ease-in-out infinite; }
  .badge-reviewing { background: #0d0d2a; color: #6a9bff; border: 1px solid #1a2a5a;
                     animation: badgePulse 2s ease-in-out infinite; }
  .badge-reworking { background: #1f1200; color: #c88600; border: 1px solid #4a3000;
                     animation: badgePulse 1.5s ease-in-out infinite; }
  .badge-arrived   { background: #0d1a0d; color: #5cb85c; border: 1px solid #1a3a1a; }

  @keyframes badgePulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.55; }
  }

  /* Board cell text */
  .cell-dest {
    font-size: 0.72rem; color: #ccc;
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  }
  .cell-dest.has-tooltip { cursor: pointer; }
  .cell-dest.has-tooltip:hover { color: #fff; }
  .cell-line {
    font-size: 0.6rem; font-weight: 700;
    padding: 1px 5px; border-radius: 2px;
    text-align: center; white-space: nowrap;
  }
  .cell-line.line-regular { background: #1a2a0d; color: #7abf40; border: 1px solid #2a4a1a; }
  .cell-line.line-express { background: #2a1e00; color: #c88600; border: 1px solid #4a3000; }
  .cell-line.line-ip      { background: #1a0d2a; color: #9a6abf; border: 1px solid #3a1a5a; }
  .cell-pri {
    font-size: 0.55rem; font-weight: 700;
    letter-spacing: 0.5px; text-transform: uppercase;
    text-align: right;
  }
  .cell-pri.pri-high   { color: #e81123; }
  .cell-pri.pri-medium { color: #c88600; }
  .cell-pri.pri-low    { color: #5a5a5a; }
  .cell-train {
    font-size: 0.6rem; font-weight: 700;
    color: #666; letter-spacing: 0.5px;
  }
  .cell-time {
    font-size: 0.6rem; color: #555;
    letter-spacing: 0.5px; text-align: right;
  }
  .cell-arrived-at {
    font-size: 0.58rem; color: #3a5a3a;
    letter-spacing: 0.5px;
  }

  /* ── Activity Row (below the board) ── */
  .activity-row {
    display: grid;
    grid-template-columns: 1fr;
    gap: 10px; padding: 0 24px 16px;
  }

  .panel {
    background: #fff; padding: 14px;
    max-height: 400px; overflow-y: auto;
    border: 1px solid #e0e0e0; border-radius: 4px;
  }
  .panel h3 {
    font-size: 0.65rem; color: #999; margin-bottom: 10px;
    text-transform: uppercase; letter-spacing: 2px; font-weight: 700;
  }
  /* Spec tooltip */
  .has-tooltip { position: relative; cursor: pointer; }
  .spec-tooltip {
    display: none; position: absolute; z-index: 100;
    left: 0; top: 100%; margin-top: 4px;
    width: 320px; max-height: 240px; overflow-y: auto;
    background: #1a1a1a; color: #ccc; border: 1px solid #444; border-radius: 4px;
    padding: 10px 12px; font-size: 0.72rem; line-height: 1.5;
    white-space: pre-wrap; word-break: break-word;
    box-shadow: 0 4px 16px rgba(0,0,0,0.3);
  }
  .has-tooltip:hover .spec-tooltip { display: block; }

  .activity-feed {
    font-family: 'Cascadia Code', 'Fira Code', 'SF Mono', monospace;
    font-size: 0.7rem; line-height: 1.7;
  }
  .activity-line { white-space: pre-wrap; word-break: break-all; }
  .line-departed { color: #2d8a2d; }
  .line-arrived  { color: #888; }
  .line-error    { color: #e81123; }
  .line-terminus { color: #b87a00; font-weight: 700; }
  .line-ops      { color: #888; }
  .line-default  { color: #666; }

  .config-section { padding: 0 24px 24px; }
  details { background: #fff; border: 1px solid #e0e0e0; border-radius: 4px; }
  details summary {
    padding: 10px 14px; cursor: pointer;
    font-size: 0.7rem; color: #999;
    text-transform: uppercase; letter-spacing: 1px; font-weight: 600;
  }
  details summary:hover { color: #333; }
  .config-body {
    padding: 0 14px 14px;
    font-family: 'SF Mono', 'Cascadia Code', monospace;
    font-size: 0.7rem; color: #888; white-space: pre-wrap;
  }

  ::-webkit-scrollbar { width: 5px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: #2a2a2a; border-radius: 3px; }
</style>
</head>
<body>

<div class="header">
  <h1>Yamanote</h1>
  <div class="header-right">
    <span id="clock"></span>
    <span id="uptime"></span>
  </div>
</div>
<div class="conn-lost" id="connBanner">Connection lost — retrying...</div>

<div class="loop-section">
  <svg class="loop-svg" viewBox="-105 -68 1025 420">
    <!-- Glow filters for train types -->
    <defs>
      <filter id="trainGlow-regular" x="-100%" y="-100%" width="300%" height="300%">
        <feGaussianBlur in="SourceGraphic" stdDeviation="3" result="blur"/>
        <feColorMatrix in="blur" type="matrix"
          values="0 0 0 0 0.6  0 0 0 0 0.8  0 0 0 0 0.2  0 0 0 0.6 0" result="green"/>
        <feMerge><feMergeNode in="green"/><feMergeNode in="SourceGraphic"/></feMerge>
      </filter>
      <filter id="trainGlow-express" x="-100%" y="-100%" width="300%" height="300%">
        <feGaussianBlur in="SourceGraphic" stdDeviation="3" result="blur"/>
        <feColorMatrix in="blur" type="matrix"
          values="0 0 0 0 1.0  0 0 0 0 0.7  0 0 0 0 0.0  0 0 0 0.6 0" result="amber"/>
        <feMerge><feMergeNode in="amber"/><feMergeNode in="SourceGraphic"/></feMerge>
      </filter>
    </defs>

    <!-- Track (stadium/pill shape) -->
    <rect x="0" y="0" width="800" height="280" rx="140" ry="140"
          fill="none" stroke="#9acd32" stroke-width="12"/>

    <!-- Invisible centerline path for train positioning -->
    <path id="trackPath"
          d="M 400,0 L 660,0 A 140,140 0 0 1 660,280 L 140,280 A 140,140 0 0 1 140,0 Z"
          fill="none" stroke="none"/>

    <!-- Station dots -->
    <circle id="dot-0" cx="400" cy="0"   r="14" fill="#fff" stroke="#ccc" stroke-width="3.5"/>
    <circle id="dot-1" cx="800" cy="140" r="14" fill="#fff" stroke="#ccc" stroke-width="3.5"/>
    <circle id="dot-2" cx="520" cy="280" r="14" fill="#fff" stroke="#ccc" stroke-width="3.5"/>
    <circle id="dot-3" cx="280" cy="280" r="14" fill="#fff" stroke="#ccc" stroke-width="3.5"/>
    <circle id="dot-4" cx="0"   cy="140" r="14" fill="#fff" stroke="#ccc" stroke-width="3.5"/>

    <!-- Station badges -->
    <!-- JY-01 Spec (above) -->
    <g id="badge-0">
      <rect id="brect-0" x="370" y="-58" width="60" height="42" rx="3"
            fill="#fff" stroke="#333" stroke-width="1.5"/>
      <text x="400" y="-36" text-anchor="middle" font-size="9"
            fill="#999" font-weight="600" letter-spacing="0.8">JY-01</text>
      <text x="400" y="-22" text-anchor="middle" font-size="14"
            fill="#333" font-weight="700">Spec</text>
    </g>
    <!-- JY-02 Engineer (right) -->
    <g id="badge-1">
      <rect id="brect-1" x="820" y="119" width="88" height="42" rx="3"
            fill="#fff" stroke="#333" stroke-width="1.5"/>
      <text x="864" y="139" text-anchor="middle" font-size="9"
            fill="#999" font-weight="600" letter-spacing="0.8">JY-02</text>
      <text x="864" y="155" text-anchor="middle" font-size="14"
            fill="#333" font-weight="700">Create</text>
    </g>
    <!-- JY-03 Review (below) -->
    <g id="badge-2">
      <rect id="brect-2" x="482" y="296" width="76" height="42" rx="3"
            fill="#fff" stroke="#333" stroke-width="1.5"/>
      <text x="520" y="316" text-anchor="middle" font-size="9"
            fill="#999" font-weight="600" letter-spacing="0.8">JY-03</text>
      <text x="520" y="332" text-anchor="middle" font-size="14"
            fill="#333" font-weight="700">Review</text>
    </g>
    <!-- JY-04 Rework (below) -->
    <g id="badge-3">
      <rect id="brect-3" x="241" y="296" width="78" height="42" rx="3"
            fill="#fff" stroke="#333" stroke-width="1.5"/>
      <text x="280" y="316" text-anchor="middle" font-size="9"
            fill="#999" font-weight="600" letter-spacing="0.8">JY-04</text>
      <text x="280" y="332" text-anchor="middle" font-size="14"
            fill="#333" font-weight="700">Rework</text>
    </g>
    <!-- JY-05 Merged (left) -->
    <g id="badge-4">
      <rect id="brect-4" x="-90" y="119" width="76" height="42" rx="3"
            fill="#fff" stroke="#333" stroke-width="1.5"/>
      <text x="-52" y="139" text-anchor="middle" font-size="9"
            fill="#999" font-weight="600" letter-spacing="0.8">JY-05</text>
      <text x="-52" y="155" text-anchor="middle" font-size="14"
            fill="#333" font-weight="700">Merged</text>
    </g>

    <!-- Train indicators (created dynamically) -->
    <g id="trainGroup"></g>

    <!-- Center text -->
    <text id="specText" x="400" y="132" text-anchor="middle"
          font-size="20" font-weight="700" fill="#333">Awaiting departure</text>
    <text id="specDetail" x="400" y="158" text-anchor="middle"
          font-size="14" fill="#999"></text>
  </svg>
</div>

<div class="agents-grid" id="agentsGrid"></div>
<div class="stats-bar" id="statsBar"></div>

<!-- Station Board -->
<div class="station-section">
  <div class="station-board">

    <!-- BACKLOG -->
    <div class="board-panel">
      <div class="board-header">
        <div class="board-header-line1">
          <span class="board-title">Backlog</span>
          <span class="board-count" id="backlogCount">0</span>
        </div>
        <div class="board-subtitle">Awaiting Departure</div>
      </div>
      <div class="board-col-headers cols-backlog">
        <span>Status</span><span>Destination</span><span>Line</span><span>Pri</span>
      </div>
      <div class="board-rows" id="backlogRows"></div>
    </div>

    <!-- TRAVELING -->
    <div class="board-panel">
      <div class="board-header">
        <div class="board-header-line1">
          <span class="board-title">Traveling</span>
          <span class="board-count" id="travelingCount">0</span>
        </div>
        <div class="board-subtitle">In Transit</div>
      </div>
      <div class="board-col-headers cols-traveling">
        <span>Status</span><span>Destination</span><span>Train</span><span>Time</span>
      </div>
      <div class="board-rows" id="travelingRows"></div>
    </div>

    <!-- ARRIVED -->
    <div class="board-panel">
      <div class="board-header">
        <div class="board-header-line1">
          <span class="board-title">Arrived</span>
          <span class="board-count" id="arrivedCount">0</span>
        </div>
        <div class="board-subtitle">Terminus</div>
      </div>
      <div class="board-col-headers cols-arrived">
        <span>Status</span><span>Destination</span><span>Arrived</span>
      </div>
      <div class="board-rows" id="arrivedRows"></div>
    </div>

  </div>
</div>

<!-- Activity Row -->
<div class="activity-row" id="activityRow">
  <div class="panel activity-panel" id="activityPanel">
    <h3>Activity</h3>
    <div class="activity-feed" id="activityFeed"></div>
  </div>
</div>

<div class="config-section">
  <details>
    <summary>Configuration</summary>
    <div class="config-body" id="configBody"></div>
  </details>
</div>

<script>
var REFRESH_MS = 10000;

var STATIONS = [
  { code: 'JY-01', name: 'Spec',        key: 'idle',       trainPos: 0 },
  { code: 'JY-02', name: 'Create',      key: 'transit',    trainPos: 25 },
  { code: 'JY-03', name: 'Review',      key: 'checkpoint', trainPos: 44 },
  { code: 'JY-04', name: 'Rework',      key: 'reroute',    trainPos: 56 },
  { code: 'JY-05', name: 'Merged',      key: 'terminal',   trainPos: 75 }
];

var STAGE_KEYS = STATIONS.map(function(s) { return s.key; });
var TRAIN_COLORS = { regular: '#9acd32', express: '#ffb300' };

var trackPath = null;
var trackLength = 0;
var trainElements = {};  // train_id -> SVG rect element

function fmtDuration(secs) {
  if (secs == null) return '-';
  var s = Math.floor(secs);
  var h = Math.floor(s / 3600);
  var m = Math.floor((s % 3600) / 60);
  var sec = s % 60;
  if (h > 0) return h + 'h ' + m + 'm';
  if (m > 0) return m + 'm ' + sec + 's';
  return sec + 's';
}

function updateClock() {
  document.getElementById('clock').textContent = new Date().toLocaleTimeString();
}

function trainLabel(trainId, trainType) {
  // "regular-0" -> "R-0", "express-1" -> "E-1"
  var prefix = trainType === 'express' ? 'E' : 'R';
  var idx = trainId.replace(/^[^-]+-/, '');
  return prefix + '-' + idx;
}

function ensureTrainEl(trainId, trainType) {
  if (trainElements[trainId]) return trainElements[trainId];
  var ns = 'http://www.w3.org/2000/svg';
  var g = document.createElementNS(ns, 'g');
  g.setAttribute('visibility', 'hidden');

  var rect = document.createElementNS(ns, 'rect');
  rect.setAttribute('width', '30');
  rect.setAttribute('height', '14');
  rect.setAttribute('rx', '3');
  rect.setAttribute('fill', TRAIN_COLORS[trainType] || '#fff');
  rect.setAttribute('stroke', '#333');
  rect.setAttribute('stroke-width', '1.5');
  g.appendChild(rect);

  var text = document.createElementNS(ns, 'text');
  text.setAttribute('x', '15');
  text.setAttribute('y', '11');
  text.setAttribute('text-anchor', 'middle');
  text.setAttribute('font-size', '9');
  text.setAttribute('font-weight', '700');
  text.setAttribute('fill', '#fff');
  text.textContent = trainLabel(trainId, trainType);
  g.appendChild(text);

  document.getElementById('trainGroup').appendChild(g);
  trainElements[trainId] = g;
  return g;
}

function positionTrainEl(el, pct, trainType) {
  if (!trackPath) {
    trackPath = document.getElementById('trackPath');
    trackLength = trackPath.getTotalLength();
  }
  if (pct < 0) {
    el.setAttribute('visibility', 'hidden');
    el.removeAttribute('filter');
    return;
  }
  el.setAttribute('visibility', 'visible');
  el.setAttribute('filter', 'url(#trainGlow-' + trainType + ')');

  var targetLen = trackLength * pct / 100;
  var pt = trackPath.getPointAtLength(targetLen);
  var pt2 = trackPath.getPointAtLength(Math.min(targetLen + 2, trackLength));
  var angle = Math.atan2(pt2.y - pt.y, pt2.x - pt.x) * 180 / Math.PI;
  el.setAttribute('transform',
    'translate(' + pt.x + ',' + pt.y + ') rotate(' + angle + ') translate(-15,-7)');
}

function renderTrains(trains) {
  // Find the most-advanced active stage across all trains for station highlighting
  var maxIdx = -1;
  var activeTrainIds = {};

  if (!trains || trains.length === 0) trains = [];

  trains.forEach(function(t, idx) {
    var el = ensureTrainEl(t.train_id, t.train_type);
    var stageIdx = STAGE_KEYS.indexOf(t.stage);
    activeTrainIds[t.train_id] = true;

    if (stageIdx > 0) {
      // Offset multiple trains slightly so they don't overlap
      var offset = idx * 3;
      positionTrainEl(el, STATIONS[stageIdx].trainPos + offset, t.train_type);
    } else {
      positionTrainEl(el, -1, t.train_type);
    }

    if (stageIdx > maxIdx) maxIdx = stageIdx;
  });

  // Hide train elements for trains that no longer exist
  for (var id in trainElements) {
    if (!activeTrainIds[id]) {
      trainElements[id].setAttribute('visibility', 'hidden');
    }
  }

  // Station dot highlighting (based on most advanced train)
  for (var i = 0; i < STATIONS.length; i++) {
    var dot = document.getElementById('dot-' + i);
    var brect = document.getElementById('brect-' + i);

    // Check if any train is at this station
    var trainAtStation = false;
    trains.forEach(function(t) {
      if (STAGE_KEYS.indexOf(t.stage) === i) trainAtStation = true;
    });

    if (trainAtStation) {
      dot.setAttribute('fill', '#ffb300');
      dot.setAttribute('stroke', '#9acd32');
      dot.classList.add('dot-active');
      brect.setAttribute('stroke', '#9acd32');
      brect.setAttribute('stroke-width', '2');
    } else if (maxIdx >= 0 && i < maxIdx) {
      dot.setAttribute('fill', '#fff');
      dot.setAttribute('stroke', '#9acd32');
      dot.classList.remove('dot-active');
      brect.setAttribute('stroke', '#9acd32');
      brect.setAttribute('stroke-width', '1.5');
    } else {
      dot.setAttribute('fill', '#fff');
      dot.setAttribute('stroke', '#ccc');
      dot.classList.remove('dot-active');
      brect.setAttribute('stroke', '#ccc');
      brect.setAttribute('stroke-width', '1.5');
    }
  }

  // Center text — show first active train's spec, or summary
  var specText = document.getElementById('specText');
  var specDetail = document.getElementById('specDetail');
  var activeTrains = trains.filter(function(t) { return t.stage !== 'idle'; });
  if (activeTrains.length === 1) {
    var t = activeTrains[0];
    specText.textContent = t.current_spec || t.train_id;
    specDetail.textContent = t.train_id + ' \u2014 Rework ' + t.rework_count + '/' + t.max_rework;
  } else if (activeTrains.length > 1) {
    specText.textContent = activeTrains.length + ' trains active';
    specDetail.textContent = activeTrains.map(function(t) { return t.train_id; }).join(', ');
  } else {
    specText.textContent = 'Awaiting departure';
    specDetail.textContent = '';
  }
}

var AGENT_DESC = {
  dispatcher:      'Writes specs from codebase analysis',
  signal:          'Monitors app logs for errors',
  station_manager: 'Resets stuck engineering branches',
  ops:             'Improves orchestrator operations'
};

function modelFamily(model) {
  if (!model) return '';
  var parts = model.split('-');
  return parts.length >= 2 ? parts[1] : model;
}

// Preserve open/closed state across refreshes
var trainGroupOpen = {};

function renderAgents(agents, trains) {
  var grid = document.getElementById('agentsGrid');
  grid.innerHTML = '';

  // Global agent cards first
  for (var name in agents) {
    var info = agents[name];
    var status = info.status || 'idle';
    var card = document.createElement('div');
    card.className = 'agent-card ' + status;

    var details = '';
    if (status === 'running') {
      details = '<div class="agent-detail">PID ' + info.pid + ' \u2014 ' + fmtDuration(info.running_for_seconds) + '</div>';
    } else if (status === 'cooldown') {
      details = '<div class="agent-detail">Retry in ' + fmtDuration(info.cooldown_remaining_seconds) + '</div>';
    } else if (info.next_run_seconds != null) {
      details = '<div class="agent-detail">Next in ' + fmtDuration(info.next_run_seconds) + '</div>';
    } else {
      details = '<div class="agent-detail">Idle</div>';
    }

    var desc = AGENT_DESC[name] || '';

    card.innerHTML =
      '<div class="agent-name">' + name.replace(/_/g, ' ') +
      '<span class="agent-badge badge-' + status + '">' + status + '</span></div>' +
      '<div class="agent-detail">' + desc + '</div>' +
      details;
    grid.appendChild(card);
  }

  // Train group cards after global agents (on a new row)
  if (trains && trains.length > 0) {
    var row = document.createElement('div');
    row.className = 'train-groups-row';
    var groups = {};
    trains.forEach(function(t) {
      if (!groups[t.train_type]) groups[t.train_type] = [];
      groups[t.train_type].push(t);
    });

    var typeOrder = ['regular', 'express'];
    typeOrder.forEach(function(type) {
      var group = groups[type];
      if (!group) return;

      var typeLabel = type === 'express' ? 'Express' : 'Regular';
      var typeColor = type === 'express' ? '#ffb300' : '#9acd32';

      var running = 0, cooldown = 0, active = 0;
      group.forEach(function(t) {
        var cs = (t.conductor && t.conductor.status) || 'idle';
        var is = (t.inspector && t.inspector.status) || 'idle';
        if (cs === 'running' || is === 'running') running++;
        if (cs === 'cooldown' || is === 'cooldown') cooldown++;
        if (t.stage !== 'idle') active++;
      });

      var summaryParts = [];
      summaryParts.push(group.length + (group.length === 1 ? ' train' : ' trains'));
      if (running > 0) summaryParts.push(running + ' running');
      else if (cooldown > 0) summaryParts.push(cooldown + ' cooldown');
      else summaryParts.push('all idle');
      if (active > 0) summaryParts.push(active + ' with spec');

      var hasRunning = running > 0;
      var isOpen = trainGroupOpen[type] || false;

      var tcard = document.createElement('div');
      tcard.className = 'train-group type-' + type + (hasRunning ? ' has-running' : '') + (isOpen ? ' open' : '');

      var headerHtml =
        '<div class="train-group-header">' +
          '<span class="train-group-arrow">\u25B6</span>' +
          '<div class="train-group-summary">' +
            '<span class="agent-name">' + typeLabel +
              '<span class="agent-badge" style="background:' + typeColor + ';color:#fff">' + summaryParts[0].toUpperCase() + '</span>' +
            '</span>' +
            '<span class="agent-detail" style="margin:0">' + summaryParts.slice(1).join(' \u00b7 ') + '</span>' +
          '</div>' +
        '</div>';

      var detailHtml = '<div class="train-group-detail">';
      group.forEach(function(t) {
        var cs = (t.conductor && t.conductor.status) || 'idle';
        var is = (t.inspector && t.inspector.status) || 'idle';
        var specLabel = t.current_spec || '';
        var parts = [t.train_id];
        if (specLabel) parts.push(specLabel);

        var statusParts = [];
        statusParts.push('C: <span class="agent-badge badge-' + cs + '">' + cs + '</span>' +
          (cs === 'running' && t.conductor ? ' ' + fmtDuration(t.conductor.running_for_seconds) : ''));
        statusParts.push('I:<span class="agent-badge badge-' + is + '">' + is + '</span>' +
          (is === 'running' && t.inspector ? ' ' + fmtDuration(t.inspector.running_for_seconds) : ''));

        detailHtml +=
          '<div class="train-detail-row">' +
            '<div class="train-detail-id">' + parts.join(' ') + '</div>' +
            '<div style="margin-top:2px">' + statusParts.join(' &nbsp;') + '</div>' +
          '</div>';
      });
      detailHtml += '</div>';

      tcard.innerHTML = headerHtml + detailHtml;

      tcard.querySelector('.train-group-header').addEventListener('click', (function(tp, el) {
        return function() {
          trainGroupOpen[tp] = !trainGroupOpen[tp];
          el.classList.toggle('open');
        };
      })(type, tcard));

      row.appendChild(tcard);
    });

    grid.appendChild(row);
  }
}

function renderStats(stats) {
  var el = document.getElementById('statsBar');
  var html = '<span class="stat-item">Launches/hr: <strong>' +
    stats.launches_last_hour + '/' + stats.max_launches_per_hour + '</strong></span>';
  if (stats.sleep_mode_active) {
    html += '<span class="stat-sleep">SERVICE SUSPENDED \u2014 ' +
      fmtDuration(stats.sleep_remaining_seconds) + ' remaining</span>';
  }
  el.innerHTML = html;
}

function esc(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

function renderBacklog(backlog) {
  var traveling = backlog._travelingTitles || {};
  var waitingSpecs = (backlog.specs || []).filter(function(s) {
    return !traveling[s.title];
  });
  document.getElementById('backlogCount').textContent = waitingSpecs.length;
  var rows = document.getElementById('backlogRows');
  if (waitingSpecs.length === 0) {
    rows.innerHTML = '<div class="board-empty">No specs waiting</div>';
    return;
  }
  rows.innerHTML = waitingSpecs.map(function(s) {
    var desc = (s.description || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    var tooltip = desc ? '<div class="spec-tooltip">' + desc + '</div>' : '';
    var isIP = (s.filename || '').endsWith('.in_progress');
    var lineClass = isIP ? 'line-ip' : (s.complexity === 'low' ? 'line-regular' : 'line-express');
    var lineLabel = isIP ? 'ACTIVE' : (s.complexity === 'low' ? 'LOW' : 'HIGH');
    var pri = s.priority || 'medium';
    return '<div class="board-row cols-backlog">' +
      '<span><span class="status-badge badge-waiting">WAITING</span></span>' +
      '<span class="cell-dest' + (desc ? ' has-tooltip' : '') + '">' + esc(s.title || '(untitled)') + tooltip + '</span>' +
      '<span><span class="cell-line ' + lineClass + '">' + lineLabel + '</span></span>' +
      '<span class="cell-pri pri-' + pri + '">' + pri.toUpperCase().slice(0,3) + '</span>' +
      '</div>';
  }).join('');
}

function renderTraveling(trains) {
  var active = (trains || []).filter(function(t) { return t.stage !== 'idle'; });
  document.getElementById('travelingCount').textContent = active.length;
  var rows = document.getElementById('travelingRows');
  if (active.length === 0) {
    rows.innerHTML = '<div class="board-empty">No trains in transit</div>';
    return;
  }
  rows.innerHTML = active.map(function(t) {
    var stageMap = { transit: 'CREATING', checkpoint: 'REVIEWING', reroute: 'REWORKING' };
    var badgeMap = { transit: 'badge-creating', checkpoint: 'badge-reviewing', reroute: 'badge-reworking' };
    var stageLabel = stageMap[t.stage] || t.stage.toUpperCase();
    var badgeCls = badgeMap[t.stage] || 'badge-waiting';
    var elapsed = null;
    if (t.conductor && t.conductor.running_for_seconds != null) elapsed = t.conductor.running_for_seconds;
    else if (t.inspector && t.inspector.running_for_seconds != null) elapsed = t.inspector.running_for_seconds;
    var prefix = t.train_type === 'express' ? 'E' : 'R';
    var idx = (t.train_id || '').replace(/^[^-]+-/, '');
    var trainLabel = prefix + '-' + idx;
    var lineClass = t.train_type === 'express' ? 'line-express' : 'line-regular';
    return '<div class="board-row cols-traveling">' +
      '<span><span class="status-badge ' + badgeCls + '">' + stageLabel + '</span></span>' +
      '<span class="cell-dest">' + esc(t.current_spec || t.train_id) + '</span>' +
      '<span><span class="cell-line ' + lineClass + '">' + trainLabel + '</span></span>' +
      '<span class="cell-time">' + (elapsed != null ? fmtDuration(elapsed) : '—') + '</span>' +
      '</div>';
  }).join('');
  return active; // return for backlog filtering
}

function renderArrived(completed) {
  document.getElementById('arrivedCount').textContent = (completed || []).length;
  var rows = document.getElementById('arrivedRows');
  if (!completed || completed.length === 0) {
    rows.innerHTML = '<div class="board-empty">No arrivals yet</div>';
    return;
  }
  rows.innerHTML = completed.map(function(c) {
    var ts = (c.merged_at || '').replace(/^\d{4}-\d{2}-\d{2} /, '');
    return '<div class="board-row cols-arrived">' +
      '<span><span class="status-badge badge-arrived">ARRIVED ✓</span></span>' +
      '<span class="cell-dest">' + esc(c.title || '(untitled)') + '</span>' +
      '<span class="cell-arrived-at">' + esc(ts) + '</span>' +
      '</div>';
  }).join('');
}

function classifyLine(line) {
  var l = line.toLowerCase();
  if (l.includes('departed') || l.includes('start ') || l.includes('start\t')) return 'line-departed';
  if (l.includes('arrived') || l.includes('done ') || l.includes('done\t')) return 'line-arrived';
  if (l.includes('error') || l.includes('overdue') || l.includes('timeout') ||
      l.includes('delay') || l.includes('cooldown') || l.includes('derailed') ||
      l.includes('fired') || l.includes('cancelled') || l.includes('abandoned')) return 'line-error';
  if (l.includes('terminus') || l.includes('merged')) return 'line-terminus';
  if (l.includes('ops report') || l.includes('ops restart') || l.includes('meta')) return 'line-ops';
  return 'line-default';
}

function renderActivity(lines) {
  var el = document.getElementById('activityFeed');
  if (!lines || lines.length === 0) {
    el.innerHTML = '<div style="color:#555">No activity yet</div>';
    return;
  }
  el.innerHTML = lines.slice(-80).map(function(line) {
    var cls = classifyLine(line);
    var escaped = line.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    return '<div class="activity-line ' + cls + '">' + escaped + '</div>';
  }).join('');
  el.scrollTop = el.scrollHeight;
}

function renderConfig(cfg) {
  document.getElementById('configBody').textContent = JSON.stringify(cfg, null, 2);
}

function renderUptime(secs) {
  document.getElementById('uptime').textContent = 'Uptime: ' + fmtDuration(secs);
}

var failCount = 0;

function refresh() {
  fetch('/api/status')
    .then(function(r) { return r.json(); })
    .then(function(data) {
      failCount = 0;
      document.getElementById('connBanner').classList.remove('visible');
      renderUptime(data.uptime_seconds);
      renderAgents(data.agents || {}, data.trains || []);
      renderTrains(data.trains || []);
      renderStats(data.stats || {});
      var activeTraveling = renderTraveling(data.trains || []);
      // Tag in-progress titles so backlog can hide them
      var travelingTitles = {};
      (activeTraveling || []).forEach(function(t) {
        if (t.current_spec) travelingTitles[t.current_spec] = true;
      });
      var bl = data.backlog || {};
      bl._travelingTitles = travelingTitles;
      renderBacklog(bl);
      renderArrived(data.completed || []);
      renderActivity(data.activity || []);
      renderConfig(data.config || {});
    })
    .catch(function() {
      failCount++;
      if (failCount >= 2) {
        document.getElementById('connBanner').classList.add('visible');
      }
    });
}

updateClock();
setInterval(updateClock, 1000);
refresh();
setInterval(refresh, REFRESH_MS);
</script>
</body>
</html>
